---
title: '从零开始的编译原理（1）：文法理论'
tags:
  - 编译
  - 文法
categories: 教程
mathjax: true
abbrlink: d76cf051
date: 2024-01-04 10:23:22
---
## 一、前言
> 一个人进行推理时…… 这种过程如果是用语词进行的，他便是在心中把各部分的名词序列连成一个整体的名词或从整体及一个部分的名词求得另一个部分的名词。
> 
> —— 托马斯•霍布斯《利维坦》第一部分 论人类 第五章 论推理与学术

<!-- more -->

当霍布斯将他的机械唯物主义运用于人的思想时，语言便成为了人脑的齿轮。人的精神当然并非机械，可这种认识却也敏锐地察觉到了语言的一些本质，那就是语言是一些规则，通过这些规则的拼凑，我们得以表述我们的思想。如今，这种规则我们称之为**文法**。

语言学家的一部分工作是从现有的自然语言中总结文法，**让语言成为机械**。但是这并不是我们的重点，我们所要探索的是一个更加年轻的领域，这个领域的研究从机械出发，却要去创造千变万化的语言，**让机械成为语言**。

## 二、自然语言的文法：一个例子
但是要开始我们的旅程，还需要从自然语言开始。当我们听别人说话，或者阅读一段句子的时候，我们究竟在理解什么？比如说，现在有这样一句话，`你知道我的叉子被放在哪里吗`。让我们尝试理解这个句子。

> 这部分默认各位已有了对词性的基本认识，至少知道名词、形容词、动词、副词等等的大致含义。否则的话，这部分内容实难描述。
> 
> 另外注意对于自然语言的相关表述可能并不完全符合人的认知的真实情况，这一部分只是为了方便理解。

首先需要明确一点，抛开我们所有的经验来看，语言就是符号的序列。也就是说语言是在时间上存在先后顺序的许多符号。这意味着我们的理解过程必定是从前到后的。对于上述句子来说，我们先读到 `你`，之后才能读到 `知`，再之后 `道`、`我` 等等。

另外，在这样不断读到一个个符号的时候，我们也并非单纯的按照字母或音节分别认识，而是首先明确哪些音节或符号共同组成相同含义，并将其作为一个单词来识别。在自然语言处理领域，这称为“分词”；而对于编译来说，这称为“词法分析”。

我们理解这个句子的过程可能是这样的：
1. 读到 `你`，这指代一个事物，为名词
2. 读到 `知道`，这指代一个行为，为动词
3. 读到 `我的`，这描述了事物的属性，为形容词
4. 读到 `叉子`，这指代了另一个事物，为名词
5. 形容词 `我的` 和名词 `叉子` 组成 `我的叉子`，也是个名词
6. 读到 `被放`，这是动词。
7. 读到 `在`，这表达了一个关系，为介词
8. 读到 `哪里`，这是名词
9. 介词 `在` 和 名词 `哪里` 组成 `在哪里`，用于描述行为，为副词
10. 动词 `被放` 和副词 `在哪里` 组成 `被放在哪里`，也是个动词。
11. 名词 `我的叉子` 和动词 `被放在哪里` 组成 `我的叉子被放在哪里`，用于陈述一个事实，称为陈述句
12. 名词 `你`、动词 `知道` 和句子 `我的叉子被放在哪里` 组成了 `你知道我的叉子被放在哪里`，是另一个陈述句。
13. 读到 `吗`，这是一个疑问语气词，用于表达疑问。
14. 句子 `你知道我的叉子被放在哪里` 和疑问语气词 `吗` 组成 `你知道我的叉子被放在哪里吗`，表达对被陈述的事情真实性的询问，是疑问句。
15. 读完了所有的单词，最后得到的疑问句就是整个句子。

在上述过程中，我们不断将小的句子成分归纳为大的句子成分，在这样归纳的过程中，我们将句子中的每个单词相互关联起来，最终理解句子表达的含义。从中我们可以知道这是一个疑问，想要得到的回答是“你”与“我的叉子被放”两个事物间是否存在“知道”的关系等等。（这样说话好别扭。）

自我们出生，我们就在特定的语言环境下学习人与人的交流方式。耳濡目染，我们的大脑就形成了对语言结构的识别能力。这使我们知道一些单词表示事物，一些单词表示行为、一些单词用于形容、一些单词用于表示关系…… 我们也明白了名词加上形容词的修饰变成了新的名词，名词加动词加上另一个名词或者句子会构成新的句子。我们在平时交流时或许并不在意，但是这样的匹配能力却天生存在于我们大脑的特定脑区中。匹配所使用的规则，我们则称其为**文法**。

## 三、从自然语言转变
### （1）归约的视角
在上一节中我们使用一个自然语言的例句描述了理解句子的过程，并从中引出了文法的概念。现在我们可以整理一下在理解这个句子的过程中用到的文法：
- 形容词加名词还是名词
- 介词加名词组成副词
- 动词加副词还是动词
- 名词加动词组成陈述句
- 名词加动词加名词也组成陈述句
- 陈述句加疑问语气词组成疑问句
- 陈述句和疑问句都是句子
- “你”、“叉子”、“哪里” 是名词
- “知道”、“被放” 是动词
- “我的” 是形容词
- “在” 是介词
- “吗” 是疑问语气词

我们可以发现，我们所有的文法描述都分为两个部分，前一部分是后一部分的组成。前一部分可以有多个成分，后一部分只能有一个。如 “名词加动词组成陈述句”，前一部分包括 “名词” 和 “动词”，而后一部分只包括 “陈述句”。

存在着这样的关系，意味着我们能够**将文法组织成树的形式**。对于一条文法规则，以整体作为父节点，以各组成成分为子节点。这样我们就得到了一个根为 “句子”、叶节点为各单词的树。我们称这样的树为文法树或语法树。对于我们的例句，其文法树如下所示：

{% asset_img  SyntaxTree.png SyntaxTree %}

> 图是在[这里](http://mshang.ca/syntree/)画的，很有意思。

如此一来，我们对句子的理解过程就抽象为从叶节点开始的文法树构建过程：在最开始，我们将每个单词都作为一棵只有一个节点的树；之后在每一步中，我们都选择一些相邻的树，用一个新的父节点作为这些树新的根；不断重复这一过程，最终我们就得到了一棵文法树。这一过程称为**归约**（Reduction）。

### （2）推导的视角
上面的叙述中我们都采用了归约的视角，这是我们理解自然语言的过程。但是如果我们选择从语言生成的过程出发，这就带来了推导的视角。

假定现在我们想要言说某些概念，表达的依旧是 “你知道我的叉子被放在哪里吗” 的含义。那么我们会如何去做呢？我们的思维过程可能是这样的：首先，我想要询问，因此需要一个疑问句，疑问句由陈述句加上疑问语气词组成；其中陈述句希望表达 “你知道我的叉子被放在哪里” 的含义…… 

这样，我们就从说一个句子出发，慢慢构建起了我们所希望说的具体内容。以这个视角，我们会发现文法树并没有发生变化，变化的是我们产生语法树的过程。这一次，我们从只有一个句子作为根节点开始，慢慢通过规则创造了叶节点，直到所有的叶节点变为我们实际可以言说的单词。这一过程就称为**推导**（Derivation）。

## 四、语言的形式化
### （1）文法的定义
我们终于从自然语言中抽象出文法树的概念。现在是时候抛弃我们此前使用的不准确的表述，以形式化的方式定义文法了。

> 但在此之前需要补充一些表示方法：
> - 我们将**符号**定义为句子的基本单位，这里所谓的符号是抽象的符号，可以是 a、abandon 或 “阿”，并未只能是单个字母。不同的符号互不相等，这些符号组成的非空有限集称为字母表，记作 $\sum$。
> - **符号串**是符号所组成的有穷序列。特别的对于长度为零的符号串，记为 $\epsilon$。
> - 符号串和符号串间可以进行**拼接**操作，若将符号看作长度为 1 的符号串，则符号也可以进行拼接操作。假设有符号或符号串 $x$ 和 $y$，则拼接操作记为 $xy$。
> - 假设现在有符号串集 $A$ 和 $B$，定义符号串集合的**乘积**操作 $AB = \{xy| x \in A, y \in B\}$，其中 $xy$ 表示符号串拼接。
> - 对符号串集合 $A$，定义**幂运算** $A^n = A^{n-1}A, A^0 = \{\epsilon\}$。
> - 对字符串集合 $A$，定义**正闭包** $A^+ = \bigcup_{i = 1}^{\infty}A^i$；以及**闭包** $A^* = A^0 \cup A^+$。

文法（Grammar）可以表示为这样一个四元组（可以简记为 $G[Z]$）
$$
  G = (V_n, V_t, P, Z)
$$
- $V_n$ 表示**非终结符号**（Non-terminal Symbol）集。即在分析句子的过程中出现的中间符号，如前一节的“名词”、“动词”。
- $V_t$ 表示**终结符号**（Terminal Symbol）集。即实际组成句子的符号，如前一节的“你”、“知道”。
- $P$ 表示**推导规则**（Production Rules）集合，同样也是文法树中父子节点间的约束条件。一条规则可以表示为有序对 $(U, x)$，其中 
  $$
  U \in V_n, x \in V^*, |U| = 1, |x| \ge 0
  $$
- $Z$ 表示**开始符号**（推导视角），或称**识别符号**（归约视角）。即文法树的根节点。$Z \in V_n$。

对于规则，为了表示有序对中两方角色的不同，常使用下面的两种表示方法
$$
\begin{align*}
  U ::= x \\
  U \rightarrow x
\end{align*}
$$

> 第二种方式称为文法的 BNF 表示（Backus-Naur Form）。对于有相同左部的规则，可以用 `|` 分隔。如下是一个例子
> $$
> \begin{align*}
>   Z & \rightarrow A | Ac \\
>   A & \rightarrow Aa | a
> \end{align*}
> $$
> 另外还有扩展的 BNF 表示，使用 `{}` 表示零或多次重复，`[]` 表示出现或不出现。当然这种表示得到的文法树和原始表示的结果并不相同。上面的 BNF 表示由 EBNF 表示如下所示
> $$
> \begin{align*}
>   Z & \rightarrow A [c] \\
>   A & \rightarrow a \{a\}
> \end{align*}
> $$


### （2）推导与归约
#### 推导与归约的形式化
推导的过程，简单来说，就是从开始符号开始，不断使用推导规则，将规则左侧的非终结符替换为右侧的符号串。当然我们也可以形式化地定义推导：

对于文法 $G$，若存在 $v \in V^{+}, w \in V^{\*}$，且 $v = xUy, w = xuy$，其中 $x, y \in V^{\*}; U \in V_n; u \in V^{\*}$，若存在 $U ::= u \in P$，则 $v$ 可**推导**出 $w$，记为 $v \Rightarrow w$。

> 那么对于归约呢？归约是推导的逆运算，所以若有 $v \Rightarrow w$，则 $w$ 可**归约**为 $v$，记为 $w \Leftarrow v$。

#### 语言集的定义
语言是满足文法的所有可能句子的集合。通过推导，我们可以定义一个文法所能表达的语言。

在此之前我们定义，若 $v$ 经过一步或多步推导可以推出 $w$，则记为 $v \stackrel{+}\Rightarrow w$；同时定义若 $v = w$ 或 $v \stackrel{+}\Rightarrow w$ 记为 $v \stackrel{*}\Rightarrow w$。

我们将从开始符号经过一系列推导得到的中间过程称为**句型**。因此 $x$ 是句型当且仅当 $Z \stackrel{\*}\Rightarrow x \land x \in V^\*$。

如果从开始符号开始，经过一系列推导得到的句型的所有符号都为终结符，则称其为**句子**。句子是推导的最终结果、是归约的初始状态。因此 $x$ 是句子当且仅当 $Z \stackrel{+}\Rightarrow x \land x \in V^{\*}_t$。

而语言就是所有从开始符号经由规则进行推导所产生的所有可能句子的集合。对于文法 $G[Z]$，记语言为 $L(G[Z])$，则有
$$
  L(G[Z]) = \{x| x \in V_t^*, Z \stackrel{+}\Rightarrow x\}
$$

#### 规范归约与最左推导
当我们

## 五、