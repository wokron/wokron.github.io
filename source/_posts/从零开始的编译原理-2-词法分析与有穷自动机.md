---
title: 从零开始的编译原理（2）：词法分析与有穷自动机
tags:
  - 编译
  - 文法
  - 有穷自动机
categories: 教程
mathjax: true
abbrlink: 24c6e53e
date: 2024-01-10 19:04:00
---
## 一、前言
> 因而，每一生物的有机形体都是一个神圣的机器，或一台无限地优越于任何人造的自动机器的自然的自动机器（automata）。因为人的技艺所制造的机器的每一部分并非机器。……而自然的机器，即有机体，在其无限小的部分仍是机器。
>
> —— 戈特弗里德·威廉·莱布尼茨《单子论》第 64 节

<!-- more -->

本章将从词法分析所用的 3 型文法入手，引入自动机的概念，并详细介绍有穷自动机的原理及实现。最终实现编译程序的词法分析模块。

## 二、正则文法的解析过程
在第 1 章的最后我们介绍了 3 型文法。3 型文法也称正则文法，特征是对于文法中的每一条规则，其右侧要么是一个终结符，要么是一个终结符加上一个非终结符，且非终结符只位于终结符的一侧。根据非终结符位置的不同分为左线性和右线性。

> 或许有些人会这样讲：“左线性是终结符在右侧；右线性是终结符在左侧”。但是这样实在太别扭了。应该说 “左线性是非终结符在左侧；右线性是非终结符在右侧”。

为什么通过这一约束，3 型文法就能区别于 2 型文法了呢？我们可以通过正则文法的解析过程来理解。

现在有一左线性正则文法 $G_1[Z]$：
$$
\begin{align*}
  Z & \rightarrow A1 \\
  A & \rightarrow B1 | 1 \\
  B & \rightarrow A0
\end{align*}
$$

现在可能不太能看得出来，但是 $G_1[Z]$ 能够接受符号串 $101011$。我们可以画出此符号串对应的文法树。

{% asset_img regex-tree1.png regex-tree1 %}

通过文法树我们可以看出，对于**左线性**正则文法 $G_1[Z]$，其文法树只向**左**增长。当然这一点从规则中也可以看出，只不过不那么直观罢了。

可为什么具有这样特性的文法就特殊了呢？接下来我们根据文法树，以归约的视角看待符号串 $101011$ 的解析过程：
1. 读入 `1`，`1` 归约得到 `A`；
2. 读入 `0`，`A0` 归约得到 `B`；
3. 读入 `1`，`B1` 归约得到 `A`；
4. ……

以此类推，我们就可以发现其中的规律。对于这样的文法，**读入一次即归约一次**。因为文法中最多只有两个符号，所以一旦读入了一个新的符号，则必定进行一次归约。

同理的，我们考虑右线性正则文法 $G_2[S]$：
$$
\begin{align*}
  S & \rightarrow 1A \\
  A & \rightarrow 0B | 1 \\
  B & \rightarrow 1A
\end{align*}
$$

$101011$ 也能被 $G_2[S]$ 接受。其文法树如下，对于**右线性**正则文法 $G_2[Z]$，其文法树只向**右**增长

{% asset_img regex-tree2.png regex-tree2 %}

而这一次我们以推导的视角来看。文法树的生成过程应该是这样的：
1. `S` 推导得到 `1A`，输出 `1`；
2. `A` 推导得到 `0B`，输出 `0`；
3. `B` 推导得到 `1A`，输出 `1`；
4. ……

其中规律是**推导一次即输出一次**。因为非终结符总是出现在左侧，所以每进行一步推导，当前句型左侧就多出一个非终结符。

由此我们可以看出，不管是左线性还是右线性，对于正则文法，符号串解析的每一步都只与目前唯一的非终结符和正在被解析的终结符有关。

正因为此，我们可以对正则文法做进一步的抽象。可将当前句型中唯一的非终结符视为当前的**状态**，由于解析了新的终结符而产生了**状态的转移**。

## 三、有穷自动机
这就引入了**有限状态机**的概念。有限状态机又称**有穷自动机**（Finite Automata），之后我们将使用有穷自动机这个名词。

有穷自动机是表示有限个状态以及在这些状态之间的转移和动作等行为的模型，可以使用图形表示。我们用圆圈表示**状态**，用圆圈间的箭头表示**状态的转移**，其中箭头上的字符表示进行这一状态转移所需要读入的字符。在有穷自动机还未读入任何字符时所处的状态称为**开始状态**，用一个小箭头指向该状态表示。另外还有**接受状态**，当有穷自动机处于该状态时，说明此前读入的符号串可被**识别/接受**，用两个同心圆表示。

> “接受” 的概念来自文法，因为有穷自动机实际上就是用于判断正则文法是否接受符号串的机器。

下面一个有穷自动机的例子可以说明上述概念。

{% asset_img automata1.png automata1 %}

> 图是在[这个网站](https://ivanzuzak.info/noam/webapps/fsm_simulator/)画的。

图中 $S、A、Z$ 均是状态。状态 $S$ 有一个小箭头指向，因此是开始状态。状态 Z 有两个同心圆，因此是接受状态。状态 $S$ 与状态 $A$ 之间有一箭头从 $S$ 指向 $A$，同时箭头上有字符 $0$，说明处于状态 $S$ 时读入字符 $0$ 可以转移到状态 $A$。其他箭头的含义同理。

判断某一符号串是否可被有穷自动机接受十分简单。只需要让有穷自动机按顺序读入符号串的每一个符号，并根据箭头做状态转移，等到读入符号串的全部符号后，查看此时是否处于接受状态即可。如果处于接受状态，则证明该符号串可以被有穷自动机识别。

还以上图中的有穷自动机为例，对于符号串 $0100$，会经过 $S \rightarrow A \rightarrow Z \rightarrow Z$ 的状态转移。最终状态为终止状态。因此 $0100$ 可以被上图的有穷自动机接受。

根据上一章，我们得知对正则文法的推导或归约等同于状态的转移，因此正则文法实际上和有穷自动机等价。正则文法的推导或归约过程可以用有穷自动机实现。下面分别给出左线性和右线性文法构造有穷自动机的方法：
- **左线性**：
  1. 对于左线性文法 $G_{L}[Z]$。将该文法中的每一个非终结符都视为状态，其中将开始符号 $Z$ 作为**接受状态**。并添加一个**开始状态** $S$。
  2. 对于文法 $G_L$ 中形如 $Q \rightarrow Rt$ 其中 $Q,R \in V_n; t \in V_t$ 的规则，为有穷自动机添加由状态 $R$ 指向状态 $Q$ 的箭头，箭头上的符号为 $t$。
  3. 对于文法 $G_L$ 中形如 $Q \rightarrow t$ 其中 $Q \in V_n; t \in V_t$ 的规则，为有穷自动机添加由状态 $S$ 指向状态 $Q$ 的箭头，箭头上的符号为 $t$。
- **右线性**：
  1. 对于左线性文法 $G_{R}[S]$。将该文法中的每一个非终结符都视为状态，其中将开始符号 $S$ 作为**开始状态**。并添加一个**接受状态** $Z$。
  2. 对于文法 $G_R$ 中形如 $Q \rightarrow tR$ 其中 $Q,R \in V_n; t \in V_t$ 的规则，为有穷自动机添加由状态 $Q$ 指向状态 $R$ 的箭头，箭头上的符号为 $t$。
  3. 对于文法 $G_R$ 中形如 $Q \rightarrow t$ 其中 $Q \in V_n; t \in V_t$ 的规则，为有穷自动机添加由状态 $Q$ 指向状态 $Z$ 的箭头，箭头上的符号为 $t$。

> 由正则文法转换为有穷自动机的过程也反映了左线性进行归约、右线性进行推导的这一区别：对于左线性，状态转移箭头所指向的是规则左侧的非终结符对应的状态；而对于右线性，状态转移箭头所指向的是规则右侧的非终结符对于的状态。

据此我们就可以根据上一节中定义的两个正则文法构造有穷自动机。实际上这两个文法所对应的有穷自动机相同。

{% asset_img automata2.png automata2 %}

对于符号串 $101011$，经过 $S \rightarrow A \rightarrow B \rightarrow A \rightarrow B \rightarrow A \rightarrow Z$ 的状态转移过程，被此有穷自动机接受。

> 左线性文法的文法树中非终结符自底向上、或右线性文法的文法树中非终结符自顶向下，所组成的序列与在有穷自动机中状态转移过程得到的状态序列相同，都是 $SABABAZ$。除了开始状态或接受状态可能不存在。

目前为止，有穷自动机看似十分简单，其实是因为我们只考虑了最简单的情况。让我们再考虑下面的正则文法 $G[S]$：
$$
\begin{align*}
  S & \rightarrow 0A | 1B | 1 \\
  A & \rightarrow \epsilon \\
  B & \rightarrow 0S
\end{align*}
$$

这是一个右线性文法，我们可以按照上面提到的方法将其构造成有穷自动机。如下图所示，图中的 $\$$ 指空字符串 $\epsilon$。

{% asset_img automata3.png automata3 %}

看似没有什么特别的。但是如果现在我问一些问题，就会发现这个有穷自动机有着很多奇怪的地方。

比如说，$1$ 能够被这一有穷自动机接受吗？因为文法中存在规则 $S \rightarrow 1$，所以肯定可以被接受。但是从有穷自动机图中看来，初始状态为 $S$，读入 $1$ 之后却可以从两个不同的箭头转移到不同的状态。既可以是接受状态 $Z$，也可以是普通状态 $B$。这样又要如何判断哪个状态是正确的呢？

又比如说，$0$ 能够被这一有穷自动机接受吗？从有穷自动机图中看来，初始状态为 $S$，读入 $0$ 之后转移到状态 $A$。但是状态 $A$ 到状态 $Z$ 之间存在一个箭头，其上的符号为 $\$$，这意味着不读入符号也可以进行状态转移。那么读入 $0$ 之后的状态究竟应该是 $A$ 还是 $Z$ 呢？

要回答这样的问题，我们不能再使用不严谨的语言了。下面我们需要将有穷自动机以数学的语言加以形式化。

## 四、有穷自动机的形式化


##


## 五、词法分析子程序
